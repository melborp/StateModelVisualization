<!--
 //---------------------------------------------------------------------
 // <copyright file="app.html">
 //    This code is licensed under the MIT License.
 //    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF
 //    ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED
 //    TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
 //    PARTICULAR PURPOSE AND NONINFRINGEMENT.
 // </copyright>
 // <summary>
 //   Part of the State Model Visualization VSO extension by the
 //     ALM Rangers.  This file displays the main view of requirements
 //     and allows for import/export.
 //  </summary>
 //---------------------------------------------------------------------
-->

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <meta name="viewport" content="user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, minimal-ui">
    <script src="sdk/scripts/VSS.SDK.js"></script>
    <script src="scripts/Cytoscape/cytoscape.min.js"></script>
    <script src="scripts/app/StateModelGraph.js"></script>
    <script src="scripts/app/StateModelVisualization.js"></script>
    <link href="css/app.css" rel="stylesheet" />
</head>
<body>
    <div class="hub-view explorer">
        <div class=" splitter horizontal hub-splitter">
            <div class="leftPane">
                <div class="left-hub-content">
                    <div class="state-model-explorer">
                        <div class="work-item-type-tree-container"></div>
                    </div>
                </div>
            </div>
            <div class="handleBar"></div>
            <div class="rightPane">
                <div class="hub-title">
                    <div class="state-model-page-title-area" title="State Model Visualizations">State Model Visualization</div>
                </div>
                <div class="hub-progress pageProgressIndicator" style="display: none;"></div>
                <div class="right-hub-content">
                    <div class="hub-pivot">
                    </div>
                    <div class="pivot-hub-content">
                        <div class="main-content">
                            <div class="toolbar hub-pivot-toolbar">
                                <ul class="menu-bar">
                                    <li title="Zoom In" class="menu-item icon-only disabled" id="ZoomIn">
                                        <span class="icon icon-zoom-in"></span>
                                    </li>
                                    <li title="Zoom Out" class="menu-item icon-only disabled" id="ZoomOut">
                                        <span class="icon icon-zoom-out"></span>
                                    </li>
                                    <!--<li title="Zoom to 100%" class="menu-item icon-only disabled" id="Zoom100">
                                        <span class="icon icon-zoom-100"></span>
                                    </li>-->
                                    <li title="Fit to Window" class="menu-item icon-only disabled" id="FitTo">
                                        <span class="icon icon-fit-to"></span>
                                    </li>
                                </ul>
                            </div>
                            <div id="cy"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script type="text/javascript">

    var treeView;
    var allWits;

    VSS.init({
        // Our extension will explicitly notify the host when we're done loading
        explicitNotifyLoaded: true,

        // We are using some VSO APIs, so we will need the module loader to load them in
        usePlatformScripts: true,
        usePlatformStyles: true
    });
    VSS.require(
        ["VSS/Controls", "VSS/Controls/TreeView", "VSS/Controls/Common", "VSS/Service", "TFS/WorkItemTracking/RestClient"],
        function(Controls, TreeView, ControlsCommon, VSS_Service, TFS_Wit_WebApi) {

            // Notify the parent frame that the host has been loaded
            VSS.notifyLoadSucceeded();

            var context = VSS.getWebContext();

            // Get a WIT client to make REST calls to VSO 
            var witClient = VSS_Service.getCollectionClient(TFS_Wit_WebApi.WorkItemTrackingHttpClient);

            witClient.getWorkItemTypes(context.project.name).then(function(wits) {
                allWits = wits;

                var container = $(".work-item-type-tree-container");

                function convertToTreeNodes(items) {
                    return $.map(items, function(item) {
                        var node = new TreeView.TreeNode(item.name);
                        node.expanded = true;
                        if (item.children && item.children.length > 0) {
                            node.addRange(convertToTreeNodes(item.children));
                        }
                        return node;
                    });
                }

                var treeViewOptions = { nodes: convertToTreeNodes(wits) };
                treeView = Controls.create(TreeView.TreeView, container, treeViewOptions);

                // Attach selectionchanged event using a DOM element containing treeview
                container.bind("selectionchanged", function(e, args) {
                    treeView.TreeNode = args.selectedNode;
                    var selectedNode = args.selectedNode;
                    if (selectedNode) {
                        var data = prepareVisualization(selectedNode.text, allWits);
                        showGraph(data);
                    }
                });

                //show first WIT as default
                var data = prepareVisualization(wits[0].name, allWits);
                showGraph(data);
                treeView.TreeNode = treeViewOptions.nodes[0];
            });
        });
</script>


    
</body>
</html>
